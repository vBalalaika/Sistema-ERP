@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<ERP.Language.SharedResource> localizer
@using ERP.Web.Areas.ProductMod.Models
@model ProductViewModel
@{
    var editPermission = false;
    var deletePermission = false;
    if ((AuthorizationService.AuthorizeAsync(User, Permissions.Products.Edit)).Result.Succeeded)
    {
        editPermission = true;
    }
    if ((AuthorizationService.AuthorizeAsync(User, Permissions.Products.Delete)).Result.Succeeded)
    {
        deletePermission = true;
    }
}

@{ if (Model.CategoryIdFilter != 0)
    {
        if (Model.ProducedBySmak != null)
            ViewData["Title"] = Model.CategoryDescriptionFilter + (Model.ProducedBySmak == true ? " - Simplemak" : " - Importados");
        else
        {
            ViewData["Title"] = Model.CategoryDescriptionFilter;
        }
    }
    else
    {
        if (Model.CategoryDescriptionFilter != null)
        {
            if (Model.ProducedBySmak == true)
            {
                ViewData["Title"] = Model.CategoryDescriptionFilter + " - Simplemak";

            }
            else
            {
                ViewData["Title"] = Model.CategoryDescriptionFilter + " - Importados";
            }

        }
        else
        {
            ViewData["Title"] = localizer["All products"];
        }

    }
}

<div class="card">

    <input type="hidden" id="CategoryIdFilter" name="CategoryFilter" value=@Model.CategoryIdFilter />
    <input type="hidden" id="ProducedBySmak" name="ProducedBySmak" value=@Model.ProducedBySmak />

    <div class="card-body table-responsive">
        <div id="div-export-buttons">
            <div class="btn-group">

                @if ((AuthorizationService.AuthorizeAsync(User, Permissions.Products.Create)).Result.Succeeded)
                {
                    <a id="btn-create" asp-area="ProductMod" asp-controller="Product" asp-action="OnGetCreateOrEdit" class="btn btn-secondary text-white" title="@localizer["Create"]">
                        <img class="tables-img-icon" src="~/images/newproduct.svg" width="35" height="25" />
                    </a>
                }

                <a id="btn-export-excel-all" class="btn btn-secondary text-white" title="@localizer["Export all"]">
                    <img class="tables-img-icon" src="~/images/Excel.svg" width="25" height="25" />
                </a>

            </div>
        </div>
        @{
            switch (Model.CategoryIdFilter)
            {
                case 0:
                    <table id="productTableComponents_0" class="table table-striped-blue table-hover w-100 nowrap">
                        <thead class="bg-thead">
                            <tr>
                                <th hidden>@localizer["Id"]</th>
                                <th>@localizer["Actions"]</th>
                                <th>@localizer["Code"]</th>
                                <th>@localizer["Description"]</th>
                                <th>@localizer["Family/Heading"]</th>
                                <th>@localizer["Raw material code"]</th>
                                <th>@localizer["Raw material description"]</th>
                                <th>@localizer["Width"]</th>
                                <th>@localizer["Length"]</th>
                                <th>@localizer["Road map"]</th>
                                <th>@localizer["Stock"]</th>
                                <th>@localizer["Unit"]</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th hidden>@localizer["Id"]</th>
                                <th>@localizer["Actions"]</th>
                                <th>@localizer["Code"]</th>
                                <th>@localizer["Description"]</th>
                                <th>@localizer["Family/Heading"]</th>
                                <th>@localizer["Raw material code"]</th>
                                <th>@localizer["Raw material description"]</th>
                                <th>@localizer["Width"]</th>
                                <th>@localizer["Length"]</th>
                                <th>@localizer["Road map"]</th>
                                <th>@localizer["Stock"]</th>
                                <th>@localizer["Unit"]</th>
                            </tr>
                        </tfoot>
                    </table>
                    break;
                case 3:
                    <table id="productTableComponents_3" class="table table-striped-blue table-hover w-100 nowrap">
                        <thead class="bg-thead">
                            <tr>
                                <th hidden>@localizer["Id"]</th>
                                <th>@localizer["Actions"]</th>
                                <th>@localizer["Code"]</th>
                                <th>@localizer["Description"]</th>
                                <th>@localizer["Family/Heading"]</th>
                                <th>@localizer["Raw material code"]</th>
                                <th>@localizer["Raw material description"]</th>
                                <th>@localizer["Width"]</th>
                                <th>@localizer["Length"]</th>
                                <th>@localizer["Road map"]</th>
                                <th>@localizer["Stock"]</th>
                                <th>@localizer["Unit"]</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th hidden>@localizer["Id"]</th>
                                <th>@localizer["Actions"]</th>
                                <th>@localizer["Code"]</th>
                                <th>@localizer["Description"]</th>
                                <th>@localizer["Family/Heading"]</th>
                                <th>@localizer["Raw material code"]</th>
                                <th>@localizer["Raw material description"]</th>
                                <th>@localizer["Width"]</th>
                                <th>@localizer["Length"]</th>
                                <th>@localizer["Road map"]</th>
                                <th>@localizer["Stock"]</th>
                                <th>@localizer["Unit"]</th>
                            </tr>
                        </tfoot>
                    </table>
                    break;
                default:

                    <table id="productTableMachines" class="table table-striped-blue table-hover w-100 nowrap" cellspacing="0">
                        <thead class="bg-thead text-white">
                            <tr>
                                <th hidden>@localizer["Id"]</th>
                                <th>@localizer["Actions"]</th>
                                <th class="text-center">@localizer["Code"]</th>
                                <th>@localizer["Description"]</th>
                                <th>@localizer["Family/Heading"]</th>
                                <th>@localizer["Road map"]</th>
                                <th class="text-center">@localizer["Stock"]</th>
                                <th>@localizer["Unit"]</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th hidden>@localizer["Id"]</th>
                                <th>@localizer["Actions"]</th>
                                <th>@localizer["Code"]</th>
                                <th>@localizer["Description"]</th>
                                <th>@localizer["Family/Heading"]</th>
                                <th>@localizer["Road map"]</th>
                                <th>@localizer["Stock"]</th>
                                <th>@localizer["Unit"]</th>
                            </tr>
                        </tfoot>
                    </table>
                    break;
            }
        }
    </div>

</div>
@section Scripts{
    <script src="~/js/site.js"></script>
    <script src="~/js/product.js"></script>
    <script>
        $(document).ready(function () {

            let editPermission = "disabled";
            let deletePermission = "disabled";

            if ("@editPermission" == "True") {
                editPermission = "";
            }
            if ("@deletePermission" == "True") {
                deletePermission = "";
            }

            let productTableComponents_0 = $("#productTableComponents_0");
            let productTableComponents_3 = $("#productTableComponents_3");
            let productTableMachines = $("#productTableMachines");

            let columnFilter_2 = "";
            let columnFilter_3 = "";
            let columnFilter_4 = "";
            let columnFilter_5 = "";
            let columnFilter_6 = "";
            let columnFilter_7 = "";
            let columnFilter_8 = "";
            let columnFilter_9 = "";
            let columnFilter_11 = "";
            let colIndexOrder = 0;
            let colOrderDirection = "";

            // To export excel
            $('#btn-export-excel-all').on('click', function () {
                window.location.href = "/productmod/product/ExportToExcel?categoryId=@Model.CategoryIdFilter&Smak=@Model.ProducedBySmak" +
                    "&columnFilter_2=" + columnFilter_2 +
                    "&columnFilter_3=" + columnFilter_3 +
                    "&columnFilter_4=" + columnFilter_4 +
                    "&columnFilter_5=" + columnFilter_5 +
                    "&columnFilter_6=" + columnFilter_6 +
                    "&columnFilter_7=" + columnFilter_7 +
                    "&columnFilter_8=" + columnFilter_8 +
                    "&columnFilter_9=" + columnFilter_9 +
                    "&columnFilter_11=" + columnFilter_11 +
                    "&colIndexOrder=" + colIndexOrder +
                    "&colOrderDirection=" + colOrderDirection;
            });

            $('.table tfoot th').each(function (i) {
                var title = $(this).text();
                if (title != "@localizer["Actions"]" && title != "@localizer["Stock"]") {
                    $(this).html('<input type="text" class="search-control" placeholder="' + title + '" data-index="' + i + '" />');
                } else {
                    $(this).html('');
                }
            });

            // For export to excel, setting filters to send to the server
            $('.search-control').keyup(function (e) {
                let colIndex = $(this).attr("data-index");
                let valueOfInput = $(this).val();
                if (colIndex == 2) {
                    columnFilter_2 = valueOfInput;
                }
                else if (colIndex == 3) {
                    columnFilter_3 = valueOfInput;
                }
                else if (colIndex == 4) {
                    columnFilter_4 = valueOfInput;
                }
                else if (colIndex == 5) {
                    columnFilter_5 = valueOfInput;
                }
                else if (colIndex == 6) {
                    columnFilter_6 = valueOfInput;
                }
                else if (colIndex == 7) {
                    columnFilter_7 = valueOfInput;
                }
                else if (colIndex == 8) {
                    columnFilter_8 = valueOfInput;
                }
                else if (colIndex == 9) {
                    columnFilter_9 = valueOfInput;
                }
                else if (colIndex == 11) {
                    columnFilter_11 = valueOfInput;
                }
            }).keyup();

            if (productTableComponents_0 != null) {
                productTableComponents_0 = $("#productTableComponents_0").DataTable({
                    "scrollY": '55vh',
                    "scrollX": true,
                    "scrollCollapse": true,
                    "scroller": true,
                    "oLanguage": @localizer["LanguageDataTable"],
                    "sAjaxSource": "/productmod/product/LoadAllComponents_0?categoryId=@Model.CategoryIdFilter&Smak=@Model.ProducedBySmak",
                    "bServerSide": true,
                    "bProcessing": true,
                    "bSearchable": true,
                    "language": {
                        "processing":
                            '<div class="text-center"> <div id="spinnerDataTable" class="spinner-border text-primary" role="status"> <span class="sr-only"></span></div></div>'
                    },
                    "order": [[2, "asc"]],
                    "columns": [
                        {
                            "data": "id",
                            "searchable": false,
                            "visible": false
                        },
                        {
                            "searchable": false,
                            "data": "id",
                            "render": function (data, type, row, meta) {

                                let producedBySmak = false;
                                if ("@Model.ProducedBySmak" == "True") {
                                    producedBySmak = true;
                                }

                                let html = '<div class="btn-group"><div class="d-flex animated--grow-in">';

                                if (row.subCategory != null) {
                                    if (row.subCategory.category != null) {
                                        if (row.subCategory.category.description != "Componentes Comprados") {
                                            if (row.structures.length > 0) {
                                                if (row.structures.some(function (e) { return e.isStandard })) {
                                                    html += '<a class="btn action-btn" title="@localizer["Standard structure"]" onclick="loadProduct(' + row.id + ', ' + true + ')" ><img class="action-img-icon" src="../../../images/Estructura estandar.svg" width="20" height="20" /></a>';
                                                } else {
                                                    html += '<a class="btn disabled action-btn" title="@localizer["Standard structure"]"><img class="action-img-icon" src="../../../images/Estructura estandar.svg" width="20" height="20" /></a>';
                                                }
                                            } else {
                                                html += '<a class="btn disabled action-btn" title="@localizer["Standard structure"]"><img class="action-img-icon" src="../../../images/Estructura estandar.svg" width="20" height="20" /></a>';
                                            }
                                        } else {
                                            html += '<a class="btn disabled action-btn" title="@localizer["Standard structure"]"><img class="action-img-icon" src="../../../images/Estructura estandar.svg" width="20" height="20" /></a>';
                                        }
                                    } else {
                                        html += '<a class="btn disabled action-btn" title="@localizer["Standard structure"]"><img class="action-img-icon" src="../../../images/Estructura estandar.svg" width="20" height="20" /></a>';
                                    }
                                } else {
                                    html += '<a class="btn disabled action-btn" title="@localizer["Standard structure"]"><img class="action-img-icon" src="../../../images/Estructura estandar.svg" width="20" height="20" /></a>';
                                }

                                if (row.subCategory != null) {
                                    if (row.subCategory.category != null) {
                                        if (row.subCategory.category.description != "Componentes Comprados") {
                                            html += '<a class="btn action-btn" title="@localizer["Configurations"]" onclick="indexStructure(' + row.id + ')"><img class="action-img-icon" src="../../../images/Configuraciones.svg" width="20" height="20" /></a>';
                                        } else {
                                            html += '<a class="btn disabled action-btn" title="@localizer["Configurations"]"><img class="action-img-icon" src="../../../images/Configuraciones.svg" width="20" height="20" /></a>';
                                        }
                                    } else {
                                        html += '<a class="btn disabled action-btn" title="@localizer["Configurations"]"><img class="action-img-icon" src="../../../images/Configuraciones.svg" width="20" height="20" /></a>';
                                    }
                                } else {
                                    html += '<a class="btn disabled action-btn" title="@localizer["Configurations"]"><img class="action-img-icon" src="../../../images/Configuraciones.svg" width="20" height="20" /></a>';
                                }

                                //if (row.archives.length > 0) {
                                //    for (i = 0; i < row.archives.length; i++) {
                                //        var path = row.archives[i].pathUrl.substring(62);
                                //        if (row.archives[i].archiveTypeId == 1) { //PLANOS
                                //            html += '<a class="btn action-btn" href="/files' + path + '" target="_blank" title="@localizer["Planos"]"><img class="action-img-icon" src="../../../images/Plano.svg" width="20" height="20" /></a>';
                                //        } else if (row.archives[i].ArchiveTypeId == 3) { //3D
                                //            html += '<a class="btn action-btn" href="/files' + path + '" target="_blank" title="@localizer["3D"]"><img class="action-img-icon" src="../../../images/3D.svg" width="20" height="20" /></a>';
                                //        }
                                //    }
                                //}

                                if (row.archives.length > 0) {
                                    let path = "jQueryModalGet('/productmod/product/GetFilesByProduct?id=" + row.id + "'" + ',' + "'" + row.codeAndDescription + "'" + ")";
                                    html += '<a title="@localizer["Files"]" class="btn action-btn @editPermission" onclick="' + path + '"><img class="action-img-icon" src="../../../images/Archivos.svg" width="20" height="20"/></a>';
                                }
                                else
                                {
                                    html += '<a title="@localizer["Files"]" class="btn action-btn disabled"><img class="action-img-icon" src="../../../images/Archivos.svg" width="20" height="20"/></a>';
                                }

                                if (row.subCategory != null) {
                                    if (row.subCategory.category != null) {
                                        if (row.subCategory.category.description != "Conjuntos" && row.subCategory.category.description != "Maquinas y Accesorios") {
                                            if (row.subCategory.category.description == "Componentes Comprados") {
                                                if (row.relProviderProducts != null && row.relProviderProducts.length > 0) {
                                                    html += '<a class="btn action-btn" title="@localizer["Providers"]" onclick="getProvidersByProduct(' + row.id + ')"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                                } else {
                                                    html += '<a class="btn disabled action-btn" title="@localizer["Providers"]"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                                }
                                            } else {
                                                html += '<a class="btn disabled action-btn" title="@localizer["Providers"]"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                            }
                                        } else {
                                            if (row.relProviderProducts != null && row.relProviderProducts.length > 0) {
                                                html += '<a class="btn action-btn" title="@localizer["Providers"]" onclick="getProvidersByProduct(' + row.id + ')"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                            } else {
                                                html += '<a class="btn disabled action-btn" title="@localizer["Providers"]"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                            }
                                        }
                                    }
                                }
                                
                                html += '<a class="btn action-btn ' + editPermission + '" title="@localizer["Edit"]" onclick="editProduct(' + row.id + ')" ><img class="action-img-icon" src="../../../images/Editar.svg" width="20" height="20" /></a>' +
                                        '<a class="btn action-btn ' + deletePermission +'" title="@localizer["Delete"]" onclick="deleteProduct(' + row.id + ', ' + @Model.CategoryIdFilter + ', ' + producedBySmak + ')" ><img class="action-img-icon" src="../../../images/Eliminar.svg" width="20" height="20" /></a>';

                                html += '</div></div>';
                                return html

                            },
                            "visible": true,
                            "width": "5%",
                        },
                        {
                            "data": "code",
                            "className": "text-center",
                            "autowidth": true,
                            "searchable": true
                        },
                        {
                            "data": "description",
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "subCategory",
                            "render": function (data) {
                                if (data != null) {
                                    return data.description
                                } else {
                                    return ''
                                }
                            },
                            "className": "text-center",
                            "autowidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    return data.rawMaterialCode
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    return data.rawMaterialDescription
                                } else {
                                    return ''
                                }
                            },
                            "className": "text-center",
                            "autowidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    let componentWidhtPiece = data.componentWidhtPiece;
                                    if (componentWidhtPiece != '') {
                                        return $.fn.dataTable.render.number('.', ',', 2).display(componentWidhtPiece);
                                    } else {
                                        return ''
                                    }
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    let componentLongPiece = data.componentLongPiece;
                                    if (componentLongPiece != '') {
                                        return $.fn.dataTable.render.number('.', ',', 2).display(componentLongPiece);
                                    } else {
                                        return ''
                                    }
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "roadmap",
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    if (data.storedStock) {
                                        return '<i class="fa fa-check-circle" style="color: #77DD77" aria-hidden="true"></i>'
                                    } else {
                                        return '<i class="fa fa-times-circle" style="color: #FF6961 " aria-hidden="true"></i>'
                                    }
                                }
                            },
                            "className": "text-center",
                            "width": "5%",
                            "searchable": true
                        },
                        {
                            "data": "unitMeasure",
                            "render": function (data) {
                                if (data != null) {
                                    return data.description
                                } else {
                                    return ''
                                }
                            },
                            "className": "text-center",
                            "autowidth": true,
                            "searchable": true
                        }
                    ],
                    initComplete: function () {
                        // Apply the search
                        this.api().columns().every(function () {
                            var that = this;

                            $('input', this.footer()).on('keyup change clear', function () {
                                if (that.search() !== this.value) {
                                    that
                                        .search(this.value)
                                        .draw();
                                }
                            });
                        });
                    }
                });

                colIndexOrder = 2;
                colOrderDirection = "asc";

                $('div.dataTables_scrollHeadInner thead').on('click', 'th', function () {

                    if ($(this).hasClass("sorting") && !$(this).hasClass("sorting_asc") && !$(this).hasClass("sorting_desc")) {
                        colOrderDirection = "asc";
                    }
                    else if ($(this).hasClass("sorting_asc")) {
                        colOrderDirection = "desc";
                    }
                    else if ($(this).hasClass("sorting_desc")) {
                        colOrderDirection = "asc";
                    }

                    switch (productTableComponents_0.column(this).index()) {
                        case 2:
                            colIndexOrder = 2;
                            break;
                        case 3:
                            colIndexOrder = 3;
                            break;
                        case 4:
                            colIndexOrder = 4;
                            break;
                        case 5:
                            colIndexOrder = 5;
                            break;
                        case 6:
                            colIndexOrder = 6;
                            break;
                        case 7:
                            colIndexOrder = 7;
                            break;
                        case 8:
                            colIndexOrder = 8;
                            break;
                        case 9:
                            colIndexOrder = 9;
                            break;
                        case 10:
                            colIndexOrder = 10;
                            break;
                        case 11:
                            colIndexOrder = 11;
                            break;
                    }
                });

            }

            if (productTableComponents_3 != null) {
                productTableComponents_3 = $("#productTableComponents_3").DataTable({
                    "scrollY": '55vh',
                    "scrollX": true,
                    "scrollCollapse": true,
                    "scroller": true,
                    "oLanguage": @localizer["LanguageDataTable"],
                    "sAjaxSource": "/productmod/product/LoadAllComponents_3?categoryId=@Model.CategoryIdFilter&Smak=@Model.ProducedBySmak",
                    "bServerSide": true,
                    "bProcessing": true,
                    "bSearchable": true,
                    "language": {
                        "processing":
                            '<div class="text-center"> <div id="spinnerDataTable" class="spinner-border text-primary" role="status"> <span class="sr-only"></span></div></div>'
                    },
                    "order": [[2, "asc"]],
                    "columns": [
                        {
                            "data": "id",
                            "searchable": false,
                            "visible": false
                        },
                        {
                            "searchable": false,
                            "data": "id",
                            "render": function (data, type, row, meta) {

                                let producedBySmak = false;
                                if ("@Model.ProducedBySmak" == "True") {
                                    producedBySmak = true;
                                }

                                let html = '<div class="btn-group"><div class="d-flex animated--grow-in">';

                                //if (row.archives.length > 0) {
                                //    for (i = 0; i < row.archives.length; i++) {
                                //        var path = row.archives[i].pathUrl.substring(62);
                                //        if (row.archives[i].archiveTypeId == 1) { //PLANOS
                                //            html += '<a class="btn action-btn" href="/files' + path + '" target="_blank" title="@localizer["Planos"]"><img class="action-img-icon" src="../../../images/Plano.svg" width="20" height="20" /></a>';
                                //        } else if (row.archives[i].ArchiveTypeId == 3) { //3D
                                //            html += '<a class="btn action-btn" href="/files' + path + '" target="_blank" title="@localizer["3D"]"><img class="action-img-icon" src="../../../images/3D.svg" width="20" height="20" /></a>';
                                //        }
                                //    }
                                //}

                                if (row.archives.length > 0) {
                                    let path = "jQueryModalGet('/productmod/product/GetFilesByProduct?id=" + row.id + "'" + ',' + "'" + row.codeAndDescription + "'" + ")";
                                    html += '<a title="@localizer["Files"]" class="btn action-btn @editPermission" onclick="' + path + '"><img class="action-img-icon" src="../../../images/Archivos.svg" width="20" height="20"/></a>';
                                }
                                else
                                {
                                    html += '<a title="@localizer["Files"]" class="btn action-btn disabled"><img class="action-img-icon" src="../../../images/Archivos.svg" width="20" height="20"/></a>';
                                }

                                html += '<a class="btn action-btn ' + editPermission + '" title="@localizer["Edit"]" onclick="editProduct(' + row.id + ')" ><img class="action-img-icon" src="../../../images/Editar.svg" width="20" height="20" /></a>' +
                                        '<a class="btn action-btn ' + deletePermission +'" title="@localizer["Delete"]" onclick="deleteProduct(' + row.id + ', ' +@Model.CategoryIdFilter + ', ' + producedBySmak + ')" ><img class="action-img-icon" src="../../../images/Eliminar.svg" width="20" height="20" /></a>';


                                html += '</div></div>';
                                return html;

                            },
                            "visible": true,
                            "width": "5%",
                        },
                        {
                            "data": "code",
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "description",
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "subCategory",
                            "render": function (data) {
                                if (data != null) {
                                    return data.description
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    return data.rawMaterialCode
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    return data.rawMaterialDescription
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    let componentWidhtPiece = data.componentWidhtPiece;
                                    if (componentWidhtPiece != '') {
                                        return $.fn.dataTable.render.number('.', ',', 2).display(componentWidhtPiece);
                                    } else {
                                        return ''
                                    }
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    let componentLongPiece = data.componentLongPiece;
                                    if (componentLongPiece != '') {
                                        return $.fn.dataTable.render.number('.', ',', 2).display(componentLongPiece);
                                    } else {
                                        return ''
                                    }
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "roadmap",
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "render": function (data) {
                                if (data != null) {
                                    if (data.storedStock) {
                                        return '<i class="fa fa-check-circle" style="color: #77DD77" aria-hidden="true"></i>'
                                    } else {
                                        return '<i class="fa fa-times-circle" style="color: #FF6961 " aria-hidden="true"></i>'
                                    }
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "unitMeasure",
                            "render": function (data) {
                                if (data != null) {
                                    return data.description
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        }
                    ],
                    initComplete: function () {
                        // Apply the search
                        this.api().columns().every(function () {
                            var that = this;

                            $('input', this.footer()).on('keyup change clear', function () {
                                if (that.search() !== this.value) {
                                    that
                                        .search(this.value)
                                        .draw();
                                }
                            });
                        });
                    }
                });

                colIndexOrder = 2;
                colOrderDirection = "asc";

                $('div.dataTables_scrollHeadInner thead').on('click', 'th', function () {

                    if ($(this).hasClass("sorting") && !$(this).hasClass("sorting_asc") && !$(this).hasClass("sorting_desc")) {
                        colOrderDirection = "asc";
                    }
                    else if ($(this).hasClass("sorting_asc")) {
                        colOrderDirection = "desc";
                    }
                    else if ($(this).hasClass("sorting_desc")) {
                        colOrderDirection = "asc";
                    }

                    switch (productTableComponents_3.column(this).index()) {
                        case 2:
                            colIndexOrder = 2;
                            break;
                        case 3:
                            colIndexOrder = 3;
                            break;
                        case 4:
                            colIndexOrder = 4;
                            break;
                        case 5:
                            colIndexOrder = 5;
                            break;
                        case 6:
                            colIndexOrder = 6;
                            break;
                        case 7:
                            colIndexOrder = 7;
                            break;
                        case 8:
                            colIndexOrder = 8;
                            break;
                        case 9:
                            colIndexOrder = 9;
                            break;
                        case 10:
                            colIndexOrder = 10;
                            break;
                        case 11:
                            colIndexOrder = 11;
                            break;
                    }
                });

            }

            if (productTableMachines != null) {
                productTableMachines = $("#productTableMachines").DataTable({
                    "scrollY": '55vh',
                    "scrollX": true,
                    "scrollCollapse": true,
                    "scroller": true,
                    "oLanguage": @localizer["LanguageDataTable"],
                    "sAjaxSource": "/productmod/product/LoadAllMachines?categoryId=@Model.CategoryIdFilter&Smak=@Model.ProducedBySmak",
                    "bServerSide": true,
                    "bProcessing": true,
                    "bSearchable": true,
                    "language": {
                        "processing":
                            '<div class="text-center"> <div id="spinnerDataTable" class="spinner-border text-primary" role="status"> <span class="sr-only"></span></div></div>'
                    },
                    "order": [[2, "asc"]],
                    "columns": [
                        {
                            "data": "id",
                            "searchable": false,
                            "visible": false
                        },
                        {
                            "searchable": false,
                            "data": "data",
                            "render": function (data, type, row, meta) {

                                let producedBySmak = false;
                                if ("@Model.ProducedBySmak" == "True") {
                                    producedBySmak = true;
                                }

                                let html = '<div class="btn-group"><div class="d-flex animated--grow-in">';

                                if (row.subCategory != null) {
                                    if (row.subCategory.category != null) {
                                        if (row.subCategory.category.description != "Componentes Comprados" && row.subCategory.category.description != "Instrumentos para producción") {
                                            if (row.structures.length > 0) {
                                                if (row.structures.some(function (e) { return e.isStandard })) {
                                                    html += '<a class="btn action-btn" title="@localizer["Standard structure"]" onclick="loadProduct(' + row.id + ', ' + true + ')" ><img class="action-img-icon" src="../../../images/Estructura estandar.svg" width="20" height="20" /></a>';
                                                } else {
                                                    html += '<a class="btn disabled action-btn" title="@localizer["Standard structure"]"><img class="action-img-icon" src="../../../images/Estructura estandar.svg" width="20" height="20" /></a>';
                                                }

                                            } else {
                                                html += '<a class="btn disabled action-btn" title="@localizer["Standard structure"]"><img class="action-img-icon" src="../../../images/Estructura estandar.svg" width="20" height="20" /></a>';
                                            }
                                        }
                                    }
                                }

                                if (row.subCategory != null) {
                                    if (row.subCategory.category != null) {
                                        if (row.subCategory.category.description != "Componentes Comprados" && row.subCategory.category.description != "Instrumentos para producción") {
                                            html += '<a class="btn action-btn" title="@localizer["Configurations"]" onclick="indexStructure(' + row.id + ')"><img class="action-img-icon" src="../../../images/Configuraciones.svg" width="20" height="20" /></a>';
                                        }
                                    }
                                }

                                //if (row.archives.length > 0) {
                                //    for (i = 0; i < row.archives.length; i++) {
                                //        var path = row.archives[i].pathUrl.substring(62);
                                //        if (row.archives[i].archiveTypeId == 1) { //PLANOS
                                //            html += '<a class="btn action-btn" href="/files' + path + '" target="_blank" title="@localizer["Planos"]"><img class="action-img-icon" src="../../../images/Plano.svg" width="20" height="20" /></a>';
                                //        } else if (row.archives[i].ArchiveTypeId == 3) { //3D
                                //            html += '<a class="btn action-btn" href="/files' + path + '" target="_blank" title="@localizer["3D"]"><img class="action-img-icon" src="../../../images/3D.svg" width="20" height="20" /></a>';
                                //        }
                                //    }
                                //}

                                if (row.archives.length > 0) {
                                    let path = "jQueryModalGet('/productmod/product/GetFilesByProduct?id=" + row.id + "'" + ',' + "'" + row.codeAndDescription + "'" + ")";
                                    html += '<a title="@localizer["Files"]" class="btn action-btn @editPermission" onclick="' + path + '"><img class="action-img-icon" src="../../../images/Archivos.svg" width="20" height="20"/></a>';
                                }
                                else
                                {
                                    html += '<a title="@localizer["Files"]" class="btn action-btn disabled"><img class="action-img-icon" src="../../../images/Archivos.svg" width="20" height="20"/></a>';
                                }

                                if (row.subCategory != null) {
                                    if (row.subCategory.category != null) {
                                        if (row.subCategory.category.description != "Conjuntos" && row.subCategory.category.description != "Maquinas y Accesorios") {
                                            if (row.subCategory.category.description == "Componentes Comprados") {
                                                if (row.relProviderProducts != null && row.relProviderProducts.length > 0) {
                                                    html += '<a class="btn action-btn" title="@localizer["Providers"]" onclick="getProvidersByProduct(' + row.id + ')"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                                } else {
                                                    html += '<a class="btn disabled action-btn" title="@localizer["Providers"]"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                                }
                                            } else if (row.subCategory.category.description == "Instrumentos para producción") {

                                            } else {
                                                html += '<a class="btn disabled action-btn" title="@localizer["Providers"]"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                            }
                                        } else {
                                            if (row.subCategory.category.description == "Maquinas y Accesorios") {

                                            }
                                            else if (row.relProviderProducts != null && row.relProviderProducts.length > 0) {
                                                html += '<a class="btn action-btn" title="@localizer["Providers"]" onclick="getProvidersByProduct(' + row.id + ')"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                            } else {
                                                html += '<a class="btn disabled action-btn" title="@localizer["Providers"]"><img class="action-img-icon" src="../../../images/Proveedores.svg" width="20" height="20" /></a>';
                                            }
                                        }
                                    }
                                }

                                
                                html += '<a class="btn action-btn ' + editPermission + '" title="@localizer["Edit"]" onclick="editProduct(' + row.id + ')" ><img class="action-img-icon" src="../../../images/Editar.svg" width="20" height="20" /></a>' +
                                        '<a class="btn action-btn ' + deletePermission +'" title="@localizer["Delete"]" onclick="deleteProduct(' + row.id + ', ' + @Model.CategoryIdFilter + ', ' + producedBySmak + ')" ><img class="action-img-icon" src="../../../images/Eliminar.svg" width="20" height="20" /></a>';


                                html += '</div></div>';
                                return html
                            },
                            "visible": true,
                            "width": "2%",
                        },
                        {
                            "data": "code",
                            "className": "text-center",
                            "width": "5%",
                            "searchable": true
                        },
                        {
                            "data": "description",
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "subCategory",
                            "className": "text-center",
                            "render": function (data) {
                                if (data != null) {
                                    return data.description
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "roadmap",
                            "autoWidth": true,
                            "searchable": true
                        },
                        {
                            "data": "productFeature",
                            "className": "text-center",
                            "render": function (data) {
                                if (data != null) {
                                    if (data.storedStock) {
                                        return '<i class="fa fa-check-circle" style="color: #77DD77" aria-hidden="true"></i>'
                                    } else {
                                        return '<i class="fa fa-times-circle" style="color: #FF6961 " aria-hidden="true"></i>'
                                    }
                                }
                            },
                            "autoWidth": true,
                            "searchable": false
                        },
                        {
                            "data": "subCategory",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                                if (data != null) {
                                    if (data.category != null) {
                                        if (data.category.description == "Componentes Comprados") {
                                            if (row.unitMeasure != null) {
                                                return row.unitMeasure.description
                                            } else {
                                                return ''
                                            }
                                        } else {
                                            return ''
                                        }
                                    } else {
                                        return ''
                                    }
                                } else {
                                    return ''
                                }
                            },
                            "autoWidth": true,
                            "searchable": true
                        }
                    ],
                    initComplete: function () {
                        // Apply the search
                        this.api().columns().every(function () {
                            var that = this;
                            $('input', this.footer()).on('keyup change clear', function () {
                                if (that.search() !== this.value) {
                                    that
                                        .search(this.value)
                                        .draw();
                                }
                            });
                        });
                    }
                });

                colIndexOrder = 2;
                colOrderDirection = "asc";

                $('div.dataTables_scrollHeadInner thead').on('click', 'th', function () {

                    if ($(this).hasClass("sorting") && !$(this).hasClass("sorting_asc") && !$(this).hasClass("sorting_desc")) {
                        colOrderDirection = "asc";
                    }
                    else if ($(this).hasClass("sorting_asc")) {
                        colOrderDirection = "desc";
                    }
                    else if ($(this).hasClass("sorting_desc")) {
                        colOrderDirection = "asc";
                    }

                    switch (productTableMachines.column(this).index()) {
                        case 2:
                            colIndexOrder = 2;
                            break;
                        case 3:
                            colIndexOrder = 3;
                            break;
                        case 4:
                            colIndexOrder = 4;
                            break;
                        case 5:
                            colIndexOrder = 5;
                            break;
                        case 6:
                            colIndexOrder = 6;
                            break;
                        case 7:
                            colIndexOrder = 7;
                            break;
                    }
                });

            }

        });

        function editProduct(id) {
            window.location.href = '@Url.Action("OnGetCreateOrEdit", "Product")/' + id;
        }

        function deleteProduct(id, categoryId, producedBySmak) {
            if (confirm('@localizer["Are you sure to delete this record?"]')) {
                let url = "/productmod/product/OnPostDelete?id=" + id + "&categoryId=" + categoryId + "&producedBySmak=" + producedBySmak;
                $.ajax({
                    url: url,
                    type: "POST",
                    success: function (response) {
                        if (response.isValid && response.dataTable == "productTableComponents_0") {
                            $("#productTableComponents_0").DataTable().clear();
                            $("#productTableComponents_0").DataTable().ajax.reload();
                        }
                        if (response.isValid && response.dataTable == "productTableComponents_3") {
                            $("#productTableComponents_3").DataTable().clear();
                            $("#productTableComponents_3").DataTable().ajax.reload();
                        }
                        if (response.isValid && response.dataTable == "productTableMachines") {
                            $("#productTableMachines").DataTable().clear();
                            $("#productTableMachines").DataTable().ajax.reload();
                        }
                    }
                });
            }
        }

        function loadProduct(id, isStandard) {
            window.location.href = "/productmod/structure/LoadProduct?productId=" + id + "&isStandard=" + isStandard;
        }

        function indexStructure(id) {
            window.location.href = "/productmod/structure/index?productId=" + id;
        }

        function getProvidersByProduct(productId) {
            url = "/productmod/product/GetProvidersByProduct?id=" + productId;
            jQueryModalGetModify(url);
        }

        jQueryModalGetModify = (url) => {
            try {
                $.ajax({
                    type: 'GET',
                    url: url,
                    contentType: false,
                    processData: false,
                    success: function (res) {
                        $('#form-modal .modal-header').html('<h5 class="modal-title">' + res.codeAndDescription + '</h5> <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>');
                        $('#form-modal .modal-body').html(res.html);
                        $('#form-modal').modal('show');
                    },
                    error: function (err) {
                        console.log(err)
                    }
                })
                //to prevent default form submit event
                return false;
            } catch (ex) {
                console.log(ex)
            }
        }

    </script>
}